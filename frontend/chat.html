<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="style.css">
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body class="bg-slate-900 text-slate-100 h-screen overflow-hidden">
    <div id="app" class="h-full flex">
        
        <!-- LEFT SECTION: Sidebar -->
        <div class="w-80 bg-slate-800 border-r border-slate-700 flex flex-col">
            
            <!-- My Profile & Status -->
            <div class="p-4 bg-slate-900/50 border-b border-slate-700 flex items-center gap-3">
                <img :src="myAvatar" class="w-12 h-12 rounded-full bg-slate-600">
                <div>
                    <h2 class="font-bold text-lg">{{ myUsername }}</h2>
                    <!-- Status Dropdown -->
                    <select v-model="myStatus" @change="updateStatus" class="bg-transparent text-xs outline-none cursor-pointer text-slate-400 hover:text-white">
                        <option value="Online">ðŸŸ¢ Online</option>
                        <option value="Busy">ðŸ”´ Busy</option>
                        <option value="Away">ðŸŸ¡ Away</option>
                    </select>
                </div>
            </div>

            <!-- Lists -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4">
                
                <!-- Friends / Users -->
                <div class="mb-6">
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-3 tracking-wider">Friends ({{ users.length }})</h3>
                    <ul>
                        <li v-for="user in users" :key="user.username" 
                            @click="selectChat('private', user.username)"
                            class="flex items-center gap-3 p-2 rounded-lg cursor-pointer transition mb-1"
                            :class="isActive('private', user.username) ? 'bg-blue-600/20 border border-blue-600/50' : 'hover:bg-slate-700'">
                            
                            <div class="relative">
                                <img :src="user.avatar" class="w-10 h-10 rounded-full bg-slate-700">
                                <div class="absolute bottom-0 right-0 w-3 h-3 border-2 border-slate-800 rounded-full"
                                     :class="getStatusColor(user.status)"></div>
                            </div>
                            <div>
                                <p class="text-sm font-medium">{{ user.username }}</p>
                                <p class="text-[10px] text-slate-400">{{ user.status }}</p>
                            </div>
                        </li>
                    </ul>
                </div>

                <!-- Groups -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Groups</h3>
                        <button @click="createGroup" class="hover:text-blue-400"><i class="ph ph-plus-circle text-lg"></i></button>
                    </div>
                    <ul>
                        <li v-for="group in groups" :key="group.name"
                            @click="selectChat('group', group.name)"
                            class="flex flex-col p-2 rounded-lg cursor-pointer transition mb-1"
                            :class="isActive('group', group.name) ? 'bg-blue-600/20 border border-blue-600/50' : 'hover:bg-slate-700'">
                            
                            <div class="flex items-center gap-2">
                                <span class="text-slate-400 text-lg">#</span>
                                <span class="text-sm font-medium">{{ group.name }}</span>
                            </div>
                            
                            <!-- Join Logic -->
                            <div v-if="isActive('group', group.name) && !group.members.includes(myUsername)" class="mt-2">
                                <button @click.stop="joinGroup(group.name)" class="w-full py-1 bg-blue-600 text-xs rounded hover:bg-blue-500">Join Group</button>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- RIGHT SECTION: Chat Area -->
        <div class="flex-1 flex flex-col bg-slate-900 relative">
            
            <div v-if="activeChat" class="flex-1 flex flex-col h-full">
                <!-- Header -->
                <div class="h-16 border-b border-slate-700 flex items-center px-6 justify-between bg-slate-800/50">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">{{ activeChat.type === 'group' ? '#' : '@' }}</span>
                        <div>
                            <h2 class="font-bold text-lg">{{ activeChat.id }}</h2>
                            <p v-if="typingInfo" class="text-xs text-blue-400 animate-pulse">{{ typingInfo }}</p>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar">
                    <div v-for="(msg, i) in currentMessages" :key="i" 
                         class="flex gap-3" 
                         :class="msg.from === myUsername ? 'flex-row-reverse' : ''">
                        
                        <img :src="msg.avatar" class="w-8 h-8 rounded-full self-end bg-slate-700">
                        
                        <div class="max-w-[70%]">
                            <p v-if="activeChat.type === 'group' && msg.from !== myUsername" class="text-[10px] text-slate-400 mb-1 ml-1">{{ msg.from }}</p>
                            
                            <div class="p-3 rounded-2xl shadow-md text-sm"
                                 :class="msg.from === myUsername ? 'bg-blue-600 text-white rounded-br-none' : 'bg-slate-700 text-slate-200 rounded-bl-none'">
                                
                                <img v-if="msg.type === 'image'" :src="msg.content" class="rounded-lg max-w-full">
                                <p v-else class="whitespace-pre-wrap">{{ msg.content }}</p>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-1 text-right">{{ msg.timestamp }}</p>
                        </div>
                    </div>
                </div>

                <!-- Input -->
                <div class="p-4 bg-slate-800 border-t border-slate-700">
                    <!-- Guard: Must join group to chat -->
                    <div v-if="activeChat.type === 'group' && !isMember(activeChat.id)" class="text-center text-slate-400 text-sm">
                        You must join this group to send messages.
                    </div>

                    <form v-else @submit.prevent="sendMessage" class="flex gap-3 items-end bg-slate-900 p-2 rounded-xl border border-slate-700">
                        <!-- Image Upload -->
                        <label class="p-2 text-slate-400 hover:text-blue-400 cursor-pointer">
                            <i class="ph ph-image text-xl"></i>
                            <input type="file" accept="image/*" @change="sendImage" class="hidden">
                        </label>

                        <input v-model="inputMessage" @input="handleTyping" placeholder="Type a message..." 
                               class="flex-1 bg-transparent outline-none text-white py-2">
                        
                        <button type="submit" class="p-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-white">
                            <i class="ph ph-paper-plane-right text-xl"></i>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Empty State -->
            <div v-else class="flex-1 flex flex-col items-center justify-center text-slate-600">
                <i class="ph ph-chat-circle-text text-6xl mb-4"></i>
                <p>Select a friend or group to start chatting</p>
            </div>

        </div>
    </div>
    
    <script src="chat.js"></script>
</body>
</html>
